<!-- fcm_token.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM í† í° ë°›ê¸°</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 15px; margin: 10px; width: 100%; font-size: 16px; }
        .token { word-break: break-all; background: #f0f0f0; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ“± FCM í† í° ë°›ê¸°</h1>
    <button onclick="getToken()">í† í° ë°›ê¸°</button>
    <div id="result" class="token">ì—¬ê¸°ì— í† í°ì´ í‘œì‹œë©ë‹ˆë‹¤</div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
        import { getMessaging, getToken } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDBJ70D3x5xmmA_doiKsQMD0mkj2C3OUeE",
            authDomain: "food-notification-af4dd.firebaseapp.com",
            projectId: "food-notification-af4dd",
            storageBucket: "food-notification-af4dd.firebasestorage.app",
            messagingSenderId: "260905646650",
            appId: "1:260905646650:web:ac1c902f9659fa8a8d5303",
            measurementId: "G-N9KV1KLT9S"
        };

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        window.getToken = async () => {
            try {
                console.log('FCM í† í° ë°›ê¸° ì‹œì‘...');

                // 1. ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
                if (!('Notification' in window)) {
                    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                    document.getElementById('result').textContent = 'ë¸Œë¼ìš°ì €ê°€ ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ';
                    return;
                }

                if (!('serviceWorker' in navigator)) {
                    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Service Workerë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                    document.getElementById('result').textContent = 'Service Worker ë¯¸ì§€ì›';
                    return;
                }

                // 2. Service Worker ë“±ë¡ ë° í™œì„±í™” ëŒ€ê¸°
                console.log('Service Worker ë“±ë¡ ì¤‘...');
                const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                console.log('Service Worker ë“±ë¡ ì™„ë£Œ:', registration);

                // Service Workerê°€ í™œì„±í™”ë  ë•Œê¹Œì§€ ëŒ€ê¸°
                if (registration.installing) {
                    console.log('Service Worker ì„¤ì¹˜ ì¤‘...');
                    await new Promise((resolve) => {
                        registration.installing.addEventListener('statechange', () => {
                            if (registration.installing.state === 'installed') {
                                resolve();
                            }
                        });
                    });
                }

                if (registration.waiting) {
                    console.log('Service Worker ëŒ€ê¸° ì¤‘...');
                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                }

                if (registration.active) {
                    console.log('Service Worker í™œì„±í™”ë¨');
                } else {
                    console.log('Service Worker í™œì„±í™” ëŒ€ê¸°...');
                    await new Promise((resolve) => {
                        navigator.serviceWorker.addEventListener('controllerchange', resolve);
                    });
                }

                // 3. ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
                console.log('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­...');
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    alert('ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!');
                    return;
                }
                console.log('ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨');

                // 4. ì ì‹œ ëŒ€ê¸° (Service Worker ì™„ì „ ì¤€ë¹„)
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 5. FCM í† í° ë°›ê¸°
                console.log('FCM í† í° ìƒì„± ì¤‘...');
                const token = await getToken(messaging, {
                    vapidKey: 'BE-gUivy9Vspx0l8cWaJrEmqmMboFEv9sz04g_OdPOuBjvDBrlgLJ7UTo09zJkeF-3zk8GxSg-gaByJwZlb9vv4',
                    serviceWorkerRegistration: registration  // ë“±ë¡ëœ Service Worker ëª…ì‹œì  ì „ë‹¬
                });

                if (token) {
                    document.getElementById('result').textContent = token;
                    console.log('FCM Token:', token);
                    alert('í† í°ì„ ë°›ì•˜ìŠµë‹ˆë‹¤!');
                } else {
                    alert('í† í°ì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    document.getElementById('result').textContent = 'í† í° ìƒì„± ì‹¤íŒ¨';
                }

            } catch (error) {
                console.error('Error:', error);
                alert('ì—ëŸ¬: ' + error.message);
                document.getElementById('result').textContent = 'ì—ëŸ¬: ' + error.message;
            }
        };
    </script>
</body>
</html>